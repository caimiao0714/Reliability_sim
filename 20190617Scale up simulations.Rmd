---
title: "Scale up Bayesian estimation for NHPP using `rstan`"
author: "Miao Cai <miao.cai@slu.edu>"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2: 
    number_sections: true
    toc: no
header-includes:
  - \usepackage{soul}
  - \usepackage{float}
  - \usepackage[table]{xcolor}
  - \usepackage{setspace}\doublespacing
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval=FALSE)
```


```{r}
pacman::p_load(rstan, dplyr, ggplot2)
source("functions/NHPP_functions.R")

plptau = '
functions{
  real nhpp_log(vector t, real beta, real theta, real tau){
    vector[num_elements(t)] loglik_part;
    real loglikelihood;
    for (i in 1:num_elements(t)){
      loglik_part[i] = log(beta) - beta*log(theta) + (beta - 1)*log(t[i]);
    }
    loglikelihood = sum(loglik_part) - (tau/theta)^beta;
    return loglikelihood;
  }
}
data {
  int<lower=0> N; //total # of obs
  int<lower=0> K; //total # of groups
  vector<lower=0>[K] tau;//truncated time
  vector<lower=0>[N] event_time; //failure time
  int s[K]; //group sizes
}
parameters{
  real<lower=0> beta;
  real<lower=0> theta;
}
model{
  int position;
  position = 1;
  for (k in 1:K){
    segment(event_time, position, s[k]) ~ nhpp(beta, theta, tau[k]);
    position = position + s[k];
  }
//PRIORS
  beta ~ gamma(1, 1);
  theta ~ gamma(1, 0.01);
}
'

plpn = '
functions{
  real nhpp_log(vector t, real beta, real theta, real tn){
    vector[num_elements(t)] loglik_part;
    real loglikelihood;
    for (i in 1:num_elements(t)){
      loglik_part[i] = log(beta) - beta*log(theta) + (beta - 1)*log(t[i]);
    }
    loglikelihood = sum(loglik_part) - (tn/theta)^beta;
    return loglikelihood;
  }
}
data {
  int<lower=0> N; //total # of obs
  int<lower=0> K; //total # of groups
  vector<lower=0>[K] tn;//truncated time
  vector<lower=0>[N] event_time; //failure time
  int s[K]; //group sizes
}
parameters{
  real<lower=0> beta;
  real<lower=0> theta;
}
model{
  int position;
  position = 1;
  for (k in 1:K){
    segment(event_time, position, s[k]) ~ nhpp(beta, theta, tn[k]);
    position = position + s[k];
  }
//PRIORS
  beta ~ gamma(1, 1);
  theta ~ gamma(1, 0.01);
}
'
```

```{r}
set.seed(123)
nhpp_5 = sim_mul_plp_n(n_shift = 50)
datstan1 = list(
    N = nrow(nhpp_5$event_dat),
    K = nrow(nhpp_5$start_end_dat),
    tn = nhpp_5$start_end_dat$end_time,
    event_time = nhpp_5$event_dat$event_time,
    s = nhpp_5$shift_length
)

fitplp <- stan(
  model_code=plpn, model_name="NHPP2", data=datstan1, 
  iter=1000,warmup = 500, chains=1, seed = 123, refresh = 0
)
```

```{r s1}
set.seed(123)
sim = 2
N = c(5, 10, 50)

sim30 = data.frame(matrix(0, nrow = sim*length(N)*2, ncol = 7))
names(sim30) = c("sample_size", "parameter", "mean", "sd", "2.5%", "50%", "97.5%")
sim30$sample_size = rep(N, each = sim*2)
sim30$parameter = rep(c("beta", "theta"), sim*length(N))
sim30[,c("mean", "sd", "2.5%", "50%", "97.5%")] = NA

for (n in seq_along(N)) {
  for (i in 1:sim) {
    nhpp_5 <- sim_mul_plp_n(N[n], beta = 2, theta = 10, mean_n = 10)
    datstan1 <- list(
      N = nrow(nhpp_5$event_dat),
      K = nrow(nhpp_5$start_end_dat),
      tn = nhpp_5$start_end_dat$end_time,
      event_time = nhpp_5$event_dat$event_time,
      s = nhpp_5$shift_length
    )
    tryCatch({fitplp <- stan(
      model_code=plpn, model_name="NHPP2", data=datstan1, 
      iter=1000,warmup = 500, chains=1, seed = 123, init = 1#, refresh = 0
    )}, error=function(e){})
    
    sim30[c(2*(n-1)*sim + 2*i-1, 2*(n-1)*sim + 2*i),
          3:7] = summary(fitplp)$c_summary[1:2,c("mean", "sd", "2.5%", "50%", "97.5%"),1]
    print(paste0("N = ", n, "; i = ", i))
  }
}


readr::write_csv(sim30, paste0("fit/fit_failure_truncate_5_10_50n", sim, ".csv"))
```



```{r s2}
set.seed(123)
sim = 1000
N = c(100, 250)

sim30 = data.frame(matrix(0, nrow = sim*length(N)*2, ncol = 7))
names(sim30) = c("sample_size", "parameter", "mean", "sd", "2.5%", "50%", "97.5%")
sim30$sample_size = rep(N, each = sim*2)
sim30$parameter = rep(c("beta", "theta"), sim*length(N))
sim30[,c("mean", "sd", "2.5%", "50%", "97.5%")] = NA

for (n in seq_along(N)) {
  for (i in 1:sim) {
    nhpp_5 <- sim_mul_plp_n(N[n], beta = 2, theta = 10, mean_n = 10)
    datstan1 <- list(
      N = nrow(nhpp_5$event_dat),
      K = nrow(nhpp_5$start_end_dat),
      tn = nhpp_5$start_end_dat$end_time,
      event_time = nhpp_5$event_dat$event_time,
      s = nhpp_5$shift_length
    )
    tryCatch({fitplp <- stan(
      model_code=plpn, model_name="NHPP2", data=datstan1, 
      iter=1000,warmup = 500, chains=1, seed = 123, init = 1#, refresh = 0
    )}, error=function(e){})
    
    sim30[c(2*(n-1)*sim + 2*i-1, 2*(n-1)*sim + 2*i),
          3:7] = summary(fitplp)$c_summary[1:2,c("mean", "sd", "2.5%", "50%", "97.5%"),1]
  }
}
readr::write_csv(sim30, paste0("fit/fit_failure_truncate_100_250", sim, ".csv"))
```




```{r s3}
set.seed(123)
sim = 1000
N = 500

sim30 = data.frame(matrix(0, nrow = sim*length(N)*2, ncol = 7))
names(sim30) = c("sample_size", "parameter", "mean", "sd", "2.5%", "50%", "97.5%")
sim30$sample_size = rep(N, each = sim*2)
sim30$parameter = rep(c("beta", "theta"), sim*length(N))
sim30[,c("mean", "sd", "2.5%", "50%", "97.5%")] = NA

for (n in seq_along(N)) {
  for (i in 1:sim) {
    nhpp_5 <- sim_mul_plp_n(N[n], beta = 2, theta = 10, mean_n = 10)
    datstan1 <- list(
      N = nrow(nhpp_5$event_dat),
      K = nrow(nhpp_5$start_end_dat),
      tn = nhpp_5$start_end_dat$end_time,
      event_time = nhpp_5$event_dat$event_time,
      s = nhpp_5$shift_length
    )
    tryCatch({fitplp <- stan(
      model_code=plpn, model_name="NHPP2", data=datstan1, 
      iter=1000,warmup = 500, chains=1, seed = 123, init = 1#, refresh = 0
    )}, error=function(e){})
    
    sim30[c(2*(n-1)*sim + 2*i-1, 2*(n-1)*sim + 2*i),
          3:7] = summary(fitplp)$c_summary[1:2,c("mean", "sd", "2.5%", "50%", "97.5%"),1]
  }
}
readr::write_csv(sim30, paste0("fit/fit_failure_truncate_500", sim, ".csv"))
```



```{r eval=TRUE}
pacman::p_load(dplyr)
d3 = data.table::fread("fit/fit_failure_truncate_5001000.csv")
d2 = data.table::fread("fit/fit_failure_truncate_100_2501000.csv")
d1 = data.table::fread("fit/fit_failure_truncate_5_10_50n1000.csv")
d = rbind(d1, d2, d3)
```

```{r eval=TRUE}
df = d %>% 
  group_by(parameter, sample_size) %>% 
  summarise(mean_posterior_mean = mean(mean), 
            sd_posterior_mean = sd(mean),
            mean_posterior_sd = mean(sd)) %>% 
  ungroup()
df_beta = df %>% 
  filter(parameter == "beta") %>% 
  select(-parameter)
df_theta = df %>% 
  filter(parameter == "theta") %>% 
  select(-parameter)
var_names = c("sample size", "mean of the posterior means", "s.d. of the posterior means", "mean of the posterior s.e.")
```

```{r eval=TRUE}
knitr::kable(df_beta, "latex", booktabs = T, 
             digits = 3, escape = FALSE, 
             caption = "Summary results for parameter $\\beta$",
             col.names = var_names)
```

```{r eval=TRUE}
knitr::kable(df_theta, "latex", booktabs = T, 
             digits = 3, escape = FALSE, 
             caption = "Summary results for parameter $\\theta$",
             col.names = var_names)
```

